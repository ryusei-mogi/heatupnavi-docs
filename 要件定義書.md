# 要件定義書（MVP版）

対象：iOSアプリ（エコキュートの「その日いちばん安い沸き上げ時間」を提示し、節約額を見せる）

---

## 1. 目的

家庭の電気単価（昼/夜）と、その日の外気温による効率差を使って、**「今日は何時に沸き上げるのが一番安いか」**を分かりやすく提示する。
毎朝のリマインドと、節約額の見える化で、継続利用を促す。

---

## 2. 前提と方針

* **自前サーバーは立てない。**
  天気は Apple の Weather サービス（WeatherKit）を利用する。
* アプリは**バックグラウンドでの定時実行に依存しない。**
  通知はローカル通知で確実に出し、計算はユーザーが開いたタイミングで行う。
* 計算は端末内で完結（天気取得以外はローカル）。

---

## 3. 用語

* 効率：同じお湯を作るのに電気がどれだけ少なくて済むかの度合い。
  成績係数（COP: Coefficient Of Performance）
  ※以降は「効率」と書く。

---

## 4. スコープ

### 4.1 MVPに含める

* 自宅位置の登録（初回のみ）
* 昼/夜の電気単価設定（時間帯と単価）
* 毎日7:00の固定文言の通知（オン/オフ可能）
* 通知タップで「最安設定画面」へ直行
* WeatherKitで時間別の外気温を取得（原則1日1回）
* 前日の「40℃相当使用湯量（L）」の入力
* 今日の最安沸き上げスケジュール提示（**最大3枠**）
* 節約額の推定表示（日・月・年）

### 4.2 MVPに含めない（将来拡張）

* 機種ごとの詳細な沸き上げ速度・効率カーブの最適化
* 待機ロス（タンク放熱）を精密にモデル化
* 市場連動など複雑な料金プランの自動取り込み
* デバイス連携（エコキュートの実機制御、HEMS連携）

---

## 5. ユーザー入力要件

### 5.1 初回セットアップ

* 位置情報の許可：「アプリ使用中のみ」でよい
* 現在地を **自宅座標として保存**（微調整UIは作らない）
* 通知の許可取得

### 5.2 設定

* 電気単価（最小）

  * 夜：開始時刻、終了時刻、単価（円/kWh）
  * 昼：開始時刻、終了時刻、単価（円/kWh）
  * ※2区分で開始。将来区分追加は拡張扱い
* 通知：オン/オフ
* 自宅の再登録（ボタンで再セットアップ）

### 5.3 毎日の入力

* 前日の **40℃相当使用湯量（L）** を入力

  * 入力が無い場合は「未入力」として扱い、節約計算は保留できる（提示自体は可能）

---

## 6. 画面要件

### 6.1 初回セットアップ画面

* 自宅登録（位置情報許可→保存）
* 通知許可→毎日7:00通知を登録
* 完了後、最安設定画面へ遷移

### 6.2 最安設定画面（ホーム）

* 今日のおすすめ沸き上げ時間帯（最大3枠）
* 基準運用との差分（推定節約額：今日）
* 月・年の推定節約額（直近平均から換算）
* 「天気更新中 / 更新済み」「最終更新日時」
* 前日の使用湯量入力導線（未入力なら入力を促す）

### 6.3 設定画面

* 通知オン/オフ
* 電気単価（昼/夜）
* 自宅を登録し直す
  -（任意）アプリの想定と注意（例：通知はリマインド、計算は起動時）

---

## 7. 通知要件

* **毎日7:00の繰り返し通知を1件だけ登録**
* 通知文は固定（例：「今日のエコキュート最安設定の確認」）
* 通知タップで **最安設定画面へ最短遷移**

  * 画面を先に出し、必要ならローディング→天気取得→再計算→表示更新
* 通知停止は確実に行う

  * 予約中（pending）と表示済み（delivered）の両方を削除
* ユーザーがOS設定で通知を切った場合

  * アプリ内トグルと状態がズレるため、権限状態を検知し、設定誘導を表示

---

## 8. 外部連携要件

* 天気取得：WeatherKit
* 取得対象：自宅座標の **時間別気温（当日分）**
* 取得頻度：原則 **1日1回**

  * 「その日初めてアプリを開いた時」に取得し、端末内にキャッシュ
* 失敗時：前回キャッシュがあればそれを使い、無ければ「天気取得失敗」として案内

---

## 9. 計算要件

### 9.1 「必要な沸き上げ量」の考え方

* 入力：前日の 40℃相当使用湯量（L）
* 目的：今日、同等量を作るのに必要なエネルギー（熱量）を推定する
* ただしMVPは「精度より継続性」を優先し、細かい条件（給水温の厳密推定など）は将来改善とする

### 9.2 時間ごとのコスト評価

* 各時間枠（例：1時間刻み）について

  * 電気単価（ユーザー設定）を適用
  * 外気温（WeatherKit）から「効率」を推定
  * 評価値は **電気単価 ÷ 効率** を基本とする
    （同じお湯を作るのに、その時間を使うと相対的に安いかを見る）

※効率の具体的な推定式（気温→効率カーブ）はMVPでは簡易モデルで実装し、将来機種データで差し替え可能にする。

### 9.3 スケジュール最適化（最大3枠）

* 入力：各時間枠の評価値、必要な沸き上げ量の目標
* 出力：最大3つの連続時間帯（枠）

  * 例：0:00–5:00 ＋ 13:00–16:00 ＋ 21:00–22:00
* 条件：

  * 選んだ枠の合計が、必要量を満たす
  * 合計コストが最小
  * 連続区間は最大3つまで

---

## 10. 基準運用（比較対象）の定義

節約額は「基準」と「提案」を同じ必要量で比較して算出する。
基準運用は次で固定する：

* **基準：夜時間帯に優先して沸き上げ**
* 夜だけで必要量が満たせない場合は、次に安い枠（昼側も含む）で補う
  （ユーザー入力で「今の運用」を取らずに成立させるための定義）

---

## 11. 節約額の表示要件

* 日：今日の推定節約額（基準 − 提案）
* 月・年：

  * 直近N日（例：7日）の平均節約額から換算して表示
  * 1日だけの年換算でブレるのを避ける
* 未入力・データ不足時：

  * スケジュール提示は可能
  * 節約額は「算出に必要な入力が不足」として保留表示

---

## 12. 機種要件（将来拡張前提の定義）

* MVPは「沸き上げ速度＝標準（固定）」でよい
* 将来的に「機種選択」に対応する

  * 機種データ（定義）はアプリ内に保持できる形にする
* 初期対応候補としてユーザー機種：

  * **エコキュート フルオートダブル追いだき 370L SRT-S377**
  * ※MVPでは機種固有の数値反映は必須にしない（枠組みだけ用意）

---

## 13. データ保存要件（端末内）

最低限、端末内に保存する：

* 自宅座標（緯度経度）
* 電気単価設定（昼/夜）
* 通知オン/オフ状態
* 入力した日別の使用湯量（40℃相当L）
* 日別の計算結果（提案スケジュール、推定節約額、算出に使った天気取得時刻）
* 天気キャッシュ（当日の時間別気温）

---

## 14. 非機能要件

* 対応OS：iOS（WeatherKit対応バージョンを下限に設定）
* プライバシー：

  * 位置情報は初回登録（再登録時）にのみ使用し、常時追跡しない
  * 収集データは端末内で扱い、外部送信しない（天気取得を除く）
* 性能：

  * 24〜48枠程度の最適化は端末内で即時に完了する
* 可用性：

  * 天気取得失敗時でも、前回キャッシュがあれば表示を継続する

---

## 15. 未決事項（MVPの実装前に決める）

* 時間枠の粒度：1時間刻み or 30分刻み
* 効率（気温→効率）の簡易モデル（最低限の形）
* 必要量推定に使う固定値（例：給水温の仮定値）
* 1日の境界（当日判定）：0:00で切り替えでよいか
* 表示文言（節約額の「推定」であることの伝え方）