# 画面遷移図（MVP）

対象：HeatupNavi（iOS 17+）

目的：アプリ全体の導線（分岐・戻る・例外ルート）を一枚で把握できるようにする。

---

## 1. 遷移図（Mermaid）

```mermaid
flowchart TD
    A[起動] --> B{自宅位置は登録済み？}

    %% Setup / Home
    B -- いいえ --> S[初回セットアップ]
    B -- はい --> H[ホーム（最安設定）]

    %% Setup actions
    S --> SL[位置情報を取得]
    SL -->|許可/取得成功| SLS[自宅座標を保存]
    SL -->|拒否/失敗| SLE[エラー表示\n再試行]
    SLE --> SL

    S --> SN[通知を許可]
    SN -->|許可| SNS[7日分の通知を予約\n通知ONを保存]
    SN -->|拒否| SNE[エラー表示\n（通知なしで利用可能）]

    S --> SC[完了]
    SC -->|自宅位置が保存済み| H

    %% Home navigation
    H -->|タップ| U[使用湯量入力]
    H -->|タップ| ST[設定]

    %% Back behavior
    U -->|戻る| H
    ST -->|戻る| H

    %% Notification tap route
    OSN[ローカル通知] -->|タップ| H

    %% Permission settings (external)
    SNE -.-> IOS[OS設定アプリ]
    SLE -.-> IOS
    IOS -.-> S
```

---

## 2. 分岐条件（入口）

* 起動直後の分岐
  * 自宅位置が未登録 → 初回セットアップへ
  * 自宅位置が登録済み → ホームへ
* 通知タップ時
  * 常にホームへ直行（途中画面が開いていても、ホームへ戻す）

---

## 3. 戻る動作

* ホーム →（使用湯量入力/設定）→ **戻るでホームへ**
* 初回セットアップはルート画面扱い（戻る遷移なし）

---

## 4. 例外ルート（権限拒否など）

### 4.1 位置情報

* 拒否/失敗：セットアップ画面内でエラー表示し、再試行導線を出す
* OS設定で許可状態を変更したい場合：設定アプリへ誘導（※ボタン追加は検討）

### 4.2 通知

* 拒否：セットアップ画面内でエラー表示
* 通知は拒否されてもアプリ利用は可能（通知予約は行わない）
* OS設定で許可状態を変更したい場合：設定アプリへ誘導（※ボタン追加は検討）
* 実装差分メモ：現状のセットアップ画面は「通知が許可済みでないと完了できない」挙動になっているため、仕様に合わせる場合は活性条件の調整が必要

---

## 5. 補足（実装メモ）

* 画面の実体
  * Setup：`HeatupNavi/UI/Views/SetupView.swift`
  * Home：`HeatupNavi/UI/Views/HomeView.swift`
  * Usage：`HeatupNavi/UI/Views/UsageInputView.swift`
  * Settings：`HeatupNavi/UI/Views/SettingsView.swift`
* ルーティング（通知タップ含む）
  * `HeatupNavi/App/RootView.swift`
  * `HeatupNavi/App/AppEntry.swift`
