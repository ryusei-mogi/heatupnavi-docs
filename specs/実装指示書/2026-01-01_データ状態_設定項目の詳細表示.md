# 実装指示書: データ状態に「設定した項目」の詳細を表示する

作成日: 2026-01-01

## 背景 / 現状

- ホームの「データ状態」カード → `DataStatusDetailView`（`HeatupNavi/UI/Views/DataStatusDetailView.swift`）は、現状 **天気/使用湯量/位置** しか表示していない。
- しかし計算に影響する「設定した項目」（単価/生活制約/ソーラー/プロ設定/通知など）が、データ状態から見えないため「いま何を前提に計算しているか」が追いにくい。
- さらに `DataStatusDetailView` は `NavigationLink(value:)` を持つが、`.navigationDestination(for: Route.self)` が無く、シート内ナビゲーションが成立しない可能性がある（`SavingsDetailView` は destination を持っている）。

## 目的

データ状態（詳細）で、**計算に使う主要な設定値とその状態** を確認できるようにし、次の行動（設定変更/入力）へ迷わず遷移できるようにする。

## スコープ（MVP）

### 追加で表示する「設定した項目」

1. 通知
   - アプリ内トグル（`AppSetting.notificationEnabled`）
   - OS権限状態（`UNAuthorizationStatus`）
   - 「今日だけミュート」状態（`AppSetting.notificationsMutedUntilDay`）
2. 電気単価（昼/夜）
   - 時間帯（start/end）と単価（円/kWh）
   - 最終更新（`TariffSetting.updatedAt`）
3. 生活制約
   - `minContinuousMinutes` / `maxSegments`
   - 使える/避けたい時間帯（`LifeConstraintSetting.windows` の件数と概要）
   - 今日の「沸き上げ不要」（`DailyBoilOverride.skipBoil`）
4. ソーラーパネル
   - 利用ON/OFF、売電単価、パネル容量、方角、影（`SolarSetting`）
   - 最終更新（`SolarSetting.updatedAt`）
5. プロ設定（機種プロファイル）
   - プリセット or 任意入力のどちらか
   - タンク容量、貯湯温度、給水温（自動/手動）、保温ロス（`MachineProfileSetting`）
   - 最終更新（`MachineProfileSetting.updatedAt`）
6. 自宅位置
   - 保存有無・保存日時（`HomeLocation.savedAt`）
   - 座標はプライバシー上、MVPでは表示しない（必要なら「概ねの市区町村」等に落とすのを別途検討）
7. 計算スロット
   - `timeSlotMinutes`（`AppSetting.timeSlotMinutes`）

### 非スコープ

- データ状態画面から設定値を編集する（編集は既存の設定画面/生活制約画面に寄せる）
- iCloud同期やCSVなど「計算に使わない」項目の詳細（必要なら別カードに分離）

## データ取得（実装方針）

### 取得元（SwiftData）

- `AppModelActor.fetchSettingsSnapshot()` は、以下を一括で返せるため優先して使う（`HeatupNavi/Persistence/Store.swift`）
  - `TariffSettingDTO`
  - `AppSettingDTO`
  - `LifeConstraintSettingDTO`
  - `SolarSettingDTO`
  - `MachineProfileSettingDTO`
  - `HomeLocationDTO?`
- 今日の沸き上げ不要は別途
  - `AppModelActor.fetchDailyBoilOverride(day: DayKey.today())`

### 取得元（外部/システム）

- 通知権限: `NotificationScheduler.authorizationStatus()`（`HeatupNavi/Services/NotificationScheduler.swift`）

## 画面/責務（MVVM）

### 方針

- View（`DataStatusDetailView`）は表示と軽いイベントのみ。
- 読み込みは状態管理役（ViewModel）に寄せ、`loadIfNeeded()` で多重実行を防ぐ。
- SwiftDataの `@Model` は渡さず、DTOと表示用の値（String/Bool/Dateなど）だけを扱う。

### 追加する状態管理役

- `HeatupNavi/UI/ViewModels/DataStatusDetailViewModel.swift` を追加
  - `@MainActor final class DataStatusDetailViewModel: ObservableObject`
  - `@Published`（例）:
    - `isLoading`
    - `tariff: TariffSettingDTO?`
    - `appSetting: AppSettingDTO?`
    - `life: LifeConstraintSettingDTO?`
    - `solar: SolarSettingDTO?`
    - `machine: MachineProfileSettingDTO?`
    - `location: HomeLocationDTO?`
    - `skipBoilToday: Bool?`
    - `notificationAuthStatus: UNAuthorizationStatus?`
    - `errorMessage: String?`
  - `loadIfNeeded()`（または `load()` + ガード）で `store.fetchSettingsSnapshot()` 等をまとめて取得する

## 実装手順

### 1) ViewModel を追加

1. `HeatupNavi/UI/ViewModels/DataStatusDetailViewModel.swift` を新規追加
2. `init(store: AppModelActor, day: Date = DayKey.today())`
3. `func loadIfNeeded() async`
   - `try await store.ensureDefaults()`
   - `let (tariff, app, life, solar, machine, location) = try await store.fetchSettingsSnapshot()`
   - `let override = try await store.fetchDailyBoilOverride(day: day)`
   - `let auth = await NotificationScheduler().authorizationStatus()`
   - DTO/値を `@Published` に反映（キャンセル時は無視）

### 2) DataStatusDetailView を改修

1. `DataStatusDetailView` に `store: AppModelActor` を渡せるようにする
2. `@StateObject private var viewModel: DataStatusDetailViewModel` を持つ
3. `.task { await viewModel.loadIfNeeded() }` を追加
4. `SavingsDetailView` と同様に `.navigationDestination(for: Route.self)` を追加し、シート内の `NavigationLink(value:)` を有効化する
5. 既存の天気/使用湯量/位置セクションに加え、上記「追加で表示する設定項目」セクションを `HeatupCard` で追加
   - 各セクションは「状態バッジ（OK/注意/未設定）」を付ける
   - 「設定を開く」「生活制約を開く」などの遷移ボタンを置く（編集は遷移先で）

### 3) HomeView から store を渡す

- `HeatupNavi/UI/Views/HomeView.swift` のシート表示で
  - `DataStatusDetailView(store: viewModel.store, weatherUpdatedAt: ..., usageStatus: ...)`
  - に変更する

## 表示ルール（例）

- 通知
  - アプリ内ON + OS未許可 → warning（iOS設定へ誘導）
  - 今日だけミュート中 → 「本日は通知しません」ラベル
- 電気単価
  - `23:00–7:00 / 15.0円` のように、時間帯と単価を同じ行で見せる
- 生活制約
  - 使える/避けたい時間は「件数 + 先頭1〜2件の抜粋」程度に抑える（全表示は別画面）
  - 今日が「沸き上げ不要」なら強めの表示（計算結果が空になる理由と一致）
- プロ設定/ソーラー
  - OFFなら「未使用」と明示（計算に入れていないことが分かる）
- 自宅位置
  - 未保存ならセットアップ未完了相当として強い誘導（設定/セットアップ）

## 確認観点（手動）

- セットアップ直後（位置あり/通知拒否）で各バッジが正しく出る
- 通知ONだがOS権限を後でOFFにした場合に warning が出る
- 生活制約で「沸き上げ不要」をONにした日、データ状態にも同じ情報が出る
- 変更（単価/生活制約/ソーラー/プロ設定）後にデータ状態表示が更新される（再表示/再入場で反映）
- シート内の「使用湯量を入力する」「設定を確認する」が遷移できる（navigationDestination の有無）

## 仕様の確認事項（迷ったら先に決める）

- 自宅位置の座標を表示するか（MVPは非表示推奨）
- 生活制約の時間帯を、データ状態でどこまで見せるか（要約のみ / 全リスト）
- データ状態に「現在の計算が参照した設定スナップショット（当日固定）」まで持たせるか
  - 例: 計算結果（`CalcResult`）に「計算時の設定値」を保存して履歴で再現可能にする、など（別タスク推奨）

